"use strict";

require("core-js/modules/es6.array.copy-within");

require("core-js/modules/es6.array.every");

require("core-js/modules/es6.array.fill");

require("core-js/modules/es6.array.filter");

require("core-js/modules/es6.array.find");

require("core-js/modules/es6.array.find-index");

require("core-js/modules/es7.array.flat-map");

require("core-js/modules/es6.array.for-each");

require("core-js/modules/es6.array.from");

require("core-js/modules/es7.array.includes");

require("core-js/modules/es6.array.index-of");

require("core-js/modules/es6.array.is-array");

require("core-js/modules/es6.array.iterator");

require("core-js/modules/es6.array.last-index-of");

require("core-js/modules/es6.array.map");

require("core-js/modules/es6.array.of");

require("core-js/modules/es6.array.reduce");

require("core-js/modules/es6.array.reduce-right");

require("core-js/modules/es6.array.some");

require("core-js/modules/es6.array.sort");

require("core-js/modules/es6.array.species");

require("core-js/modules/es6.date.now");

require("core-js/modules/es6.date.to-iso-string");

require("core-js/modules/es6.date.to-json");

require("core-js/modules/es6.date.to-primitive");

require("core-js/modules/es6.date.to-string");

require("core-js/modules/es6.function.bind");

require("core-js/modules/es6.function.has-instance");

require("core-js/modules/es6.function.name");

require("core-js/modules/es6.map");

require("core-js/modules/es6.math.acosh");

require("core-js/modules/es6.math.asinh");

require("core-js/modules/es6.math.atanh");

require("core-js/modules/es6.math.cbrt");

require("core-js/modules/es6.math.clz32");

require("core-js/modules/es6.math.cosh");

require("core-js/modules/es6.math.expm1");

require("core-js/modules/es6.math.fround");

require("core-js/modules/es6.math.hypot");

require("core-js/modules/es6.math.imul");

require("core-js/modules/es6.math.log1p");

require("core-js/modules/es6.math.log10");

require("core-js/modules/es6.math.log2");

require("core-js/modules/es6.math.sign");

require("core-js/modules/es6.math.sinh");

require("core-js/modules/es6.math.tanh");

require("core-js/modules/es6.math.trunc");

require("core-js/modules/es6.number.constructor");

require("core-js/modules/es6.number.epsilon");

require("core-js/modules/es6.number.is-finite");

require("core-js/modules/es6.number.is-integer");

require("core-js/modules/es6.number.is-nan");

require("core-js/modules/es6.number.is-safe-integer");

require("core-js/modules/es6.number.max-safe-integer");

require("core-js/modules/es6.number.min-safe-integer");

require("core-js/modules/es6.number.parse-float");

require("core-js/modules/es6.number.parse-int");

require("core-js/modules/es6.object.assign");

require("core-js/modules/es6.object.create");

require("core-js/modules/es7.object.define-getter");

require("core-js/modules/es7.object.define-setter");

require("core-js/modules/es6.object.define-property");

require("core-js/modules/es6.object.define-properties");

require("core-js/modules/es7.object.entries");

require("core-js/modules/es6.object.freeze");

require("core-js/modules/es6.object.get-own-property-descriptor");

require("core-js/modules/es7.object.get-own-property-descriptors");

require("core-js/modules/es6.object.get-own-property-names");

require("core-js/modules/es6.object.get-prototype-of");

require("core-js/modules/es7.object.lookup-getter");

require("core-js/modules/es7.object.lookup-setter");

require("core-js/modules/es6.object.prevent-extensions");

require("core-js/modules/es6.object.to-string");

require("core-js/modules/es6.object.is");

require("core-js/modules/es6.object.is-frozen");

require("core-js/modules/es6.object.is-sealed");

require("core-js/modules/es6.object.is-extensible");

require("core-js/modules/es6.object.keys");

require("core-js/modules/es6.object.seal");

require("core-js/modules/es6.object.set-prototype-of");

require("core-js/modules/es7.object.values");

require("core-js/modules/es6.promise");

require("core-js/modules/es7.promise.finally");

require("core-js/modules/es6.reflect.apply");

require("core-js/modules/es6.reflect.construct");

require("core-js/modules/es6.reflect.define-property");

require("core-js/modules/es6.reflect.delete-property");

require("core-js/modules/es6.reflect.get");

require("core-js/modules/es6.reflect.get-own-property-descriptor");

require("core-js/modules/es6.reflect.get-prototype-of");

require("core-js/modules/es6.reflect.has");

require("core-js/modules/es6.reflect.is-extensible");

require("core-js/modules/es6.reflect.own-keys");

require("core-js/modules/es6.reflect.prevent-extensions");

require("core-js/modules/es6.reflect.set");

require("core-js/modules/es6.reflect.set-prototype-of");

require("core-js/modules/es6.regexp.constructor");

require("core-js/modules/es6.regexp.flags");

require("core-js/modules/es6.regexp.match");

require("core-js/modules/es6.regexp.replace");

require("core-js/modules/es6.regexp.split");

require("core-js/modules/es6.regexp.search");

require("core-js/modules/es6.regexp.to-string");

require("core-js/modules/es6.set");

require("core-js/modules/es6.symbol");

require("core-js/modules/es7.symbol.async-iterator");

require("core-js/modules/es6.string.anchor");

require("core-js/modules/es6.string.big");

require("core-js/modules/es6.string.blink");

require("core-js/modules/es6.string.bold");

require("core-js/modules/es6.string.code-point-at");

require("core-js/modules/es6.string.ends-with");

require("core-js/modules/es6.string.fixed");

require("core-js/modules/es6.string.fontcolor");

require("core-js/modules/es6.string.fontsize");

require("core-js/modules/es6.string.from-code-point");

require("core-js/modules/es6.string.includes");

require("core-js/modules/es6.string.italics");

require("core-js/modules/es6.string.iterator");

require("core-js/modules/es6.string.link");

require("core-js/modules/es7.string.pad-start");

require("core-js/modules/es7.string.pad-end");

require("core-js/modules/es6.string.raw");

require("core-js/modules/es6.string.repeat");

require("core-js/modules/es6.string.small");

require("core-js/modules/es6.string.starts-with");

require("core-js/modules/es6.string.strike");

require("core-js/modules/es6.string.sub");

require("core-js/modules/es6.string.sup");

require("core-js/modules/es6.string.trim");

require("core-js/modules/es7.string.trim-left");

require("core-js/modules/es7.string.trim-right");

require("core-js/modules/es6.typed.array-buffer");

require("core-js/modules/es6.typed.data-view");

require("core-js/modules/es6.typed.int8-array");

require("core-js/modules/es6.typed.uint8-array");

require("core-js/modules/es6.typed.uint8-clamped-array");

require("core-js/modules/es6.typed.int16-array");

require("core-js/modules/es6.typed.uint16-array");

require("core-js/modules/es6.typed.int32-array");

require("core-js/modules/es6.typed.uint32-array");

require("core-js/modules/es6.typed.float32-array");

require("core-js/modules/es6.typed.float64-array");

require("core-js/modules/es6.weak-map");

require("core-js/modules/es6.weak-set");

require("core-js/modules/web.timers");

require("core-js/modules/web.immediate");

require("core-js/modules/web.dom.iterable");

require("regenerator-runtime/runtime");

var _UserRepository = require("./repository/UserRepository");

var _DBConnection = require("./database/DBConnection");

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance"); }

function _iterableToArrayLimit(arr, i) { if (!(Symbol.iterator in Object(arr) || Object.prototype.toString.call(arr) === "[object Arguments]")) { return; } var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

var TelegramBot = require('node-telegram-bot-api');

require('dotenv').config();

var CronJob = require('cron').CronJob;

var http = require('http');

var connection = new _DBConnection.DBConnection();
var bot = new TelegramBot(process.env.BOT_TOKEN, {
  polling: true
});
var url = 'https://youtu.be/2pLT-olgUJs';
var currentJobs = [];
bot.onText(/\/start/, startHandler);

function startHandler(_x) {
  return _startHandler.apply(this, arguments);
}

function _startHandler() {
  _startHandler = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee2(msg) {
    var chatId, username, userRepo, create;
    return regeneratorRuntime.wrap(function _callee2$(_context2) {
      while (1) {
        switch (_context2.prev = _context2.next) {
          case 0:
            chatId = msg.chat.id;
            _context2.next = 3;
            return getName({
              origin: msg.from
            });

          case 3:
            username = _context2.sent;
            userRepo = new _UserRepository.UserRepository({
              connection: connection
            });
            _context2.next = 7;
            return userRepo.create({
              chatId: chatId,
              username: username
            });

          case 7:
            create = _context2.sent;
            console.log({
              create: create
            });
            bot.sendMessage(chatId, 'You were added to DB. Autoremainder will notificate you every hour. Type /help to learn more');

          case 10:
          case "end":
            return _context2.stop();
        }
      }
    }, _callee2);
  }));
  return _startHandler.apply(this, arguments);
}

bot.onText(/\/send_every (.+)/, changeFrequency);

function changeFrequency(_x2, _x3) {
  return _changeFrequency.apply(this, arguments);
}

function _changeFrequency() {
  _changeFrequency = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee3(msg, match) {
    var chatId, userRepo, changed;
    return regeneratorRuntime.wrap(function _callee3$(_context3) {
      while (1) {
        switch (_context3.prev = _context3.next) {
          case 0:
            chatId = msg.chat.id;

            if (Number(match[1])) {
              _context3.next = 4;
              break;
            }

            bot.sendMessage(chatId, 'Wrong period was specified. Please, remember thar period counts is minutes, for example, "/send_every 60" means "every 60 minutes"');
            return _context3.abrupt("return");

          case 4:
            userRepo = new _UserRepository.UserRepository({
              connection: connection
            });
            _context3.next = 7;
            return userRepo.update({
              chatId: chatId,
              frequency: match[1],
              activated: 1
            });

          case 7:
            changed = _context3.sent;
            bot.sendMessage(chatId, changed);

          case 9:
          case "end":
            return _context3.stop();
        }
      }
    }, _callee3);
  }));
  return _changeFrequency.apply(this, arguments);
}

bot.onText(/\/off/, disableNotifications);

function disableNotifications(_x4) {
  return _disableNotifications.apply(this, arguments);
}

function _disableNotifications() {
  _disableNotifications = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee4(msg) {
    var chatId, userRepo, disabled;
    return regeneratorRuntime.wrap(function _callee4$(_context4) {
      while (1) {
        switch (_context4.prev = _context4.next) {
          case 0:
            chatId = msg.chat.id;
            userRepo = new _UserRepository.UserRepository({
              connection: connection
            });
            _context4.next = 4;
            return userRepo.update({
              chatId: chatId,
              activated: 0
            });

          case 4:
            disabled = _context4.sent;

            if (currentJobs.length !== 0) {
              currentJobs = currentJobs.map(function (e) {
                if (Number(e.chatId) === Number(chatId)) {
                  e.job.stop();
                }

                return e;
              });
            } else {
              createJobs();
            }

            console.log('after disable ', currentJobs);
            bot.sendMessage(chatId, disabled);

          case 8:
          case "end":
            return _context4.stop();
        }
      }
    }, _callee4);
  }));
  return _disableNotifications.apply(this, arguments);
}

bot.onText(/\/on/, enableNotifications);

function enableNotifications(_x5) {
  return _enableNotifications.apply(this, arguments);
}

function _enableNotifications() {
  _enableNotifications = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee5(msg) {
    var chatId, userRepo, enabled;
    return regeneratorRuntime.wrap(function _callee5$(_context5) {
      while (1) {
        switch (_context5.prev = _context5.next) {
          case 0:
            chatId = msg.chat.id;
            userRepo = new _UserRepository.UserRepository({
              connection: connection
            });
            _context5.next = 4;
            return userRepo.update({
              chatId: chatId,
              activated: 1
            });

          case 4:
            enabled = _context5.sent;

            if (currentJobs.length === 0) {
              createJobs();
            } else {
              currentJobs = currentJobs.map(function (e) {
                if (Number(e.chatId) === Number(chatId)) {
                  e.job.start();
                }

                return e;
              });
            }

            console.log('after enable ', currentJobs);
            bot.sendMessage(chatId, enabled);

          case 8:
          case "end":
            return _context5.stop();
        }
      }
    }, _callee5);
  }));
  return _enableNotifications.apply(this, arguments);
}

bot.onText(/\/help/, helpMessage);

function helpMessage(_x6) {
  return _helpMessage.apply(this, arguments);
}

function _helpMessage() {
  _helpMessage = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee6(msg) {
    var chatId, message;
    return regeneratorRuntime.wrap(function _callee6$(_context6) {
      while (1) {
        switch (_context6.prev = _context6.next) {
          case 0:
            chatId = msg.chat.id;
            message = ['/off - disables auto-notifications', '/on - enables auto-notifications', '/set_every [minutes] - set notification frequency', '/info'];
            bot.sendMessage(chatId, message.join('\n'));

          case 3:
          case "end":
            return _context6.stop();
        }
      }
    }, _callee6);
  }));
  return _helpMessage.apply(this, arguments);
}

bot.onText(/\/info/, infoMessage);

function infoMessage(_x7) {
  return _infoMessage.apply(this, arguments);
}

function _infoMessage() {
  _infoMessage = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee7(msg) {
    var chatId;
    return regeneratorRuntime.wrap(function _callee7$(_context7) {
      while (1) {
        switch (_context7.prev = _context7.next) {
          case 0:
            chatId = msg.chat.id;
            bot.sendMessage(chatId, 'Бот для забывчивой зайки');

          case 2:
          case "end":
            return _context7.stop();
        }
      }
    }, _callee7);
  }));
  return _infoMessage.apply(this, arguments);
}

bot.on("polling_error", function (err) {
  return console.log(err);
});

function sendNotification(chatId) {
  return function () {
    bot.sendMessage(chatId, url);
    bot.sendMessage(chatId, 'If u done type "/off"');
  };
}

function getName(_x8) {
  return _getName.apply(this, arguments);
}

function _getName() {
  _getName = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee8(_ref2) {
    var origin, username;
    return regeneratorRuntime.wrap(function _callee8$(_context8) {
      while (1) {
        switch (_context8.prev = _context8.next) {
          case 0:
            origin = _ref2.origin;
            username = origin.first_name;

            if (origin.last_name) {
              username += ' ' + origin.last_name;
            }

            return _context8.abrupt("return", username);

          case 4:
          case "end":
            return _context8.stop();
        }
      }
    }, _callee8);
  }));
  return _getName.apply(this, arguments);
}

function createJobs() {
  return _createJobs.apply(this, arguments);
}

function _createJobs() {
  _createJobs = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee9() {
    var userRepo, _ref3, _ref4, users, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, user, job, jobDesc;

    return regeneratorRuntime.wrap(function _callee9$(_context9) {
      while (1) {
        switch (_context9.prev = _context9.next) {
          case 0:
            userRepo = new _UserRepository.UserRepository({
              connection: connection
            });
            _context9.next = 3;
            return userRepo.read({
              row: 'activated',
              value: 1
            });

          case 3:
            _ref3 = _context9.sent;
            _ref4 = _slicedToArray(_ref3, 1);
            users = _ref4[0];
            _iteratorNormalCompletion = true;
            _didIteratorError = false;
            _iteratorError = undefined;
            _context9.prev = 9;
            _iterator = users[Symbol.iterator]();

          case 11:
            if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
              _context9.next = 22;
              break;
            }

            user = _step.value;
            _context9.next = 15;
            return createJob({
              frequency: user.frequency,
              chatId: user.chatId
            });

          case 15:
            job = _context9.sent;
            job.start();
            jobDesc = {
              chatId: user.chatId,
              job: job
            };
            currentJobs.push(jobDesc);

          case 19:
            _iteratorNormalCompletion = true;
            _context9.next = 11;
            break;

          case 22:
            _context9.next = 28;
            break;

          case 24:
            _context9.prev = 24;
            _context9.t0 = _context9["catch"](9);
            _didIteratorError = true;
            _iteratorError = _context9.t0;

          case 28:
            _context9.prev = 28;
            _context9.prev = 29;

            if (!_iteratorNormalCompletion && _iterator["return"] != null) {
              _iterator["return"]();
            }

          case 31:
            _context9.prev = 31;

            if (!_didIteratorError) {
              _context9.next = 34;
              break;
            }

            throw _iteratorError;

          case 34:
            return _context9.finish(31);

          case 35:
            return _context9.finish(28);

          case 36:
          case "end":
            return _context9.stop();
        }
      }
    }, _callee9, null, [[9, 24, 28, 36], [29,, 31, 35]]);
  }));
  return _createJobs.apply(this, arguments);
}

function createJob(_x9) {
  return _createJob.apply(this, arguments);
}

function _createJob() {
  _createJob = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee10(_ref5) {
    var frequency, chatId, cronTimer, cb;
    return regeneratorRuntime.wrap(function _callee10$(_context10) {
      while (1) {
        switch (_context10.prev = _context10.next) {
          case 0:
            frequency = _ref5.frequency, chatId = _ref5.chatId;
            cronTimer = "*/".concat(frequency, " 9-21 * * *");
            _context10.next = 4;
            return sendNotification(chatId);

          case 4:
            cb = _context10.sent;
            _context10.prev = 5;
            return _context10.abrupt("return", new CronJob(cronTimer, cb));

          case 9:
            _context10.prev = 9;
            _context10.t0 = _context10["catch"](5);
            console.log(_context10.t0);

          case 12:
          case "end":
            return _context10.stop();
        }
      }
    }, _callee10, null, [[5, 9]]);
  }));
  return _createJob.apply(this, arguments);
}

function createMainWatcher() {
  return _createMainWatcher.apply(this, arguments);
}

function _createMainWatcher() {
  _createMainWatcher = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee11() {
    var cronTimer, job;
    return regeneratorRuntime.wrap(function _callee11$(_context11) {
      while (1) {
        switch (_context11.prev = _context11.next) {
          case 0:
            cronTimer = "*/60 23 * * *";
            job = new CronJob(cronTimer, function () {
              createJobs();
            });
            job.start();
            createJobs();

          case 4:
          case "end":
            return _context11.stop();
        }
      }
    }, _callee11);
  }));
  return _createMainWatcher.apply(this, arguments);
}

createMainWatcher();
http.createServer( /*#__PURE__*/function () {
  var _ref = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee(request, response) {
    return regeneratorRuntime.wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            response.end("Hello world!");

          case 1:
          case "end":
            return _context.stop();
        }
      }
    }, _callee);
  }));

  return function (_x10, _x11) {
    return _ref.apply(this, arguments);
  };
}()).listen(process.env.PORT || 8080);